name: Pull Request Checks

on:
    pull_request:
        branches:
            - main
            - develop

permissions:
    contents: read
    pull-requests: write

jobs:
    lint:
        name: Lintowanie kodu
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v5

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run linter
              run: npm run lint

    unit-tests:
        name: Testy jednostkowe
        runs-on: ubuntu-latest
        needs: lint
        steps:
            - name: Checkout repository
              uses: actions/checkout@v5

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Run unit tests with coverage
              run: npm run test:coverage

            - name: Upload coverage reports
              uses: actions/upload-artifact@v5
              with:
                  name: coverage-report
                  path: coverage/
                  retention-days: 30

            - name: Read coverage summary
              id: coverage
              run: |
                  if [ -f coverage/coverage-summary.json ]; then
                      COVERAGE=$(node -pe "
                          const summary = require('./coverage/coverage-summary.json');
                          const total = summary.total;
                          \`Lines: \${total.lines.pct}% | Statements: \${total.statements.pct}% | Functions: \${total.functions.pct}% | Branches: \${total.branches.pct}%\`
                      ")
                      echo "summary=$COVERAGE" >> $GITHUB_OUTPUT
                  else
                      echo "summary=Coverage report not found" >> $GITHUB_OUTPUT
                  fi

    status-comment:
        name: Komentarz ze statusem
        runs-on: ubuntu-latest
        needs: [lint, unit-tests]
        if: success()
        steps:
            - name: Checkout repository
              uses: actions/checkout@v5

            - name: Download coverage reports
              uses: actions/download-artifact@v6
              with:
                  name: coverage-report
                  path: coverage/

            - name: Generate coverage summary
              id: coverage
              run: |
                  if [ -f coverage/coverage-summary.json ]; then
                      node -pe "
                          const summary = require('./coverage/coverage-summary.json');
                          const total = summary.total;
                          const lines = total.lines.pct.toFixed(2);
                          const statements = total.statements.pct.toFixed(2);
                          const functions = total.functions.pct.toFixed(2);
                          const branches = total.branches.pct.toFixed(2);

                          console.log('lines=' + lines);
                          console.log('statements=' + statements);
                          console.log('functions=' + functions);
                          console.log('branches=' + branches);
                      " >> $GITHUB_OUTPUT
                  else
                      echo "lines=N/A" >> $GITHUB_OUTPUT
                      echo "statements=N/A" >> $GITHUB_OUTPUT
                      echo "functions=N/A" >> $GITHUB_OUTPUT
                      echo "branches=N/A" >> $GITHUB_OUTPUT
                  fi

            - name: Create PR comment
              uses: actions/github-script@v8
              with:
                  script: |
                      const { data: comments } = await github.rest.issues.listComments({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.issue.number,
                      });

                      const botComment = comments.find(comment => {
                          return comment.user.type === 'Bot' && comment.body.includes('âœ… Pull Request Checks - Status');
                      });

                      const coverageLines = '${{ steps.coverage.outputs.lines }}';
                      const coverageStatements = '${{ steps.coverage.outputs.statements }}';
                      const coverageFunctions = '${{ steps.coverage.outputs.functions }}';
                      const coverageBranches = '${{ steps.coverage.outputs.branches }}';

                      const commentBody = `## âœ… Pull Request Checks - Status

                      Wszystkie sprawdzenia przeszÅ‚y pomyÅ›lnie! ğŸ‰

                      ### ğŸ“Š Code Coverage
                      | Metric | Coverage |
                      |--------|----------|
                      | ğŸ“ Lines | ${coverageLines}% |
                      | ğŸ“„ Statements | ${coverageStatements}% |
                      | ğŸ”§ Functions | ${coverageFunctions}% |
                      | ğŸŒ¿ Branches | ${coverageBranches}% |

                      ### âœ“ Completed Checks
                      - âœ… Lintowanie kodu
                      - âœ… Testy jednostkowe

                      ---
                      *Workflow run: [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})*
                      `;

                      if (botComment) {
                          await github.rest.issues.updateComment({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              comment_id: botComment.id,
                              body: commentBody
                          });
                      } else {
                          await github.rest.issues.createComment({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              issue_number: context.issue.number,
                              body: commentBody
                          });
                      }

